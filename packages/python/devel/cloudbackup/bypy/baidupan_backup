#!/bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2023 JELOS (https://github.com/ohmylittlev)

# check token
if [ ! -f "~/.bypy/bypy.json" ]; then
    echo -e "百度云未授权，请运行百度云设置进行授权" 2>&1
    sleep 3
    clear && exit
fi

if [ $(( $(date +%s) - $(date -r ~/.bypy/bypy.json +%s) )) -gt 2590000 ]; then
    echo -e "百度云授权已经过期，请运行百度云设置重新进行授权" 2>&1
    sleep 3
    clear && exit
fi

CONFIGPATH="/storage/.config"

if [ -e "${CONFIGPATH}/baidupan.conf" ]
then
    source ${CONFIGPATH}/baidupan.conf
fi

ROMS_FOLDER="${ROMS_FOLDER:=/storage/roms}"
BIOS_FOLDER="${BIOS_FOLDER:=/storage/roms/bios}"

echo -e "=> ${OS_NAME} 百度云存档备份\n"

echo -e "程序会将游戏存档备份到百度云上" 2>&1

echo -e "开始下载……" 2>&1

search_path=${ROMS_FOLDER}
for entry in "$search_path"/*
do
    if [ -d "$entry" ]; then
        for subentry in "$entry"/*
        do
            case $subentry in
                *.sav|*.srm|*.auto|*.state*)
                    remote_path=$(echo $subentry | sed -e "s/\/storage\///g")
                    LANG=zh_CN.UTF-8 python -m bypy upload "${subentry}" "${remote_path}" -v
                    echo -e "${subentry} 上传完毕" 2>&1
                    ;;
                *)
                    ;;
            esac
        done
    fi
done

echo -e "\n备份已完成" 2>&1

sleep 3
clear